<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIOps RAG Demo - æ™ºèƒ½è¿ç»´æ•…éšœè¯Šæ–­</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Consolas', sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #252526;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        header h1 {
            font-size: 18px;
            font-weight: 600;
            color: #cccccc;
        }

        .selectors {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .selector-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .selector-label {
            font-size: 13px;
            color: #858585;
        }

        select {
            background: #3c3c3c;
            border: 1px solid #454545;
            color: #d4d4d4;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            outline: none;
        }

        select:hover {
            border-color: #007acc;
        }

        .main-card {
            background: #252526;
            border-radius: 8px;
            padding: 20px;
        }

        .input-section {
            margin-bottom: 30px;
        }

        .input-section label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #cccccc;
            margin-bottom: 10px;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            border-radius: 6px;
            color: #d4d4d4;
            font-size: 13px;
            font-family: 'Consolas', 'Courier New', monospace;
            resize: vertical;
            transition: border-color 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: #007acc;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        button {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            display: none !important;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-section {
            display: none;
        }

        .result-section.show {
            display: block;
        }

        .result-card {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .result-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .result-card .content {
            color: #333;
            line-height: 1.8;
            white-space: pre-wrap;
        }

        .confidence {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .confidence.high {
            background: #d4edda;
            color: #155724;
        }

        .confidence.medium {
            background: #fff3cd;
            color: #856404;
        }

        .confidence.low {
            background: #f8d7da;
            color: #721c24;
        }

        .cases-section {
            margin-top: 30px;
        }

        .case-item {
            background: white;
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
        }

        .case-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .case-title {
            font-weight: 600;
            color: #667eea;
        }

        .similarity {
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
        }

        .example-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .example-btn {
            padding: 8px 15px;
            background: #3c3c3c;
            border: 1px solid #454545;
            border-radius: 6px;
            font-size: 13px;
            color: #d4d4d4;
            cursor: pointer;
            transition: all 0.2s;
        }

        .example-btn:hover {
            background: #505050;
            transform: translateY(-1px);
        }

        /* è¾“å…¥æ¡†å®¹å™¨ */
        .textarea-wrapper {
            position: relative;
        }

        /* ========== Windsurf é£æ ¼ Agent è¾“å‡º ========== */
        #agentOutput {
            background: #252526;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .agent-output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #3c3c3c;
        }

        .output-title {
            font-size: 14px;
            font-weight: 600;
            color: #cccccc;
        }

        .streaming-badge {
            font-size: 12px;
            color: #4ec9b0;
        }

        #agentOutputContent {
            max-height: 600px;
            overflow-y: auto;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        #agentOutputContent::-webkit-scrollbar {
            width: 8px;
        }

        #agentOutputContent::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        #agentOutputContent::-webkit-scrollbar-thumb {
            background: #3c3c3c;
            border-radius: 4px;
        }

        #agentOutputContent::-webkit-scrollbar-thumb:hover {
            background: #505050;
        }

        /* æ€è€ƒé“¾ - å¯æŠ˜å  (Windsurf é£æ ¼) */
        .thought-item {
            background: #1e1e1e;
            border-left: 3px solid #007acc;
            border-radius: 4px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .thought-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .thought-header:hover {
            background: #2d2d30;
        }

        .thought-title {
            font-size: 13px;
            color: #858585;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .expand-icon {
            transition: transform 0.2s;
            font-size: 10px;
            color: #858585;
        }

        .thought-item.expanded .expand-icon {
            transform: rotate(90deg);
        }

        .thought-duration {
            color: #858585;
            font-size: 12px;
        }

        .thought-content {
            padding: 0 12px 12px 28px;
            font-size: 13px;
            line-height: 1.6;
            color: #d4d4d4;
            display: none;
        }

        .thought-item.expanded .thought-content {
            display: block;
        }

        /* å·¥å…·è°ƒç”¨ */
        .tool-call-item {
            background: #1e1e1e;
            border-left: 3px solid #4ec9b0;
            padding: 10px 12px;
            margin-bottom: 6px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 13px;
        }

        .tool-label {
            color: #4ec9b0;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 12px;
        }

        .tool-command {
            color: #ce9178;
            line-height: 1.4;
        }

        /* å·¥å…·ç»“æœ */
        .tool-result-item {
            background: #1e1e1e;
            border-left: 3px solid #6a9955;
            padding: 10px 12px;
            margin-bottom: 12px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
        }

        .tool-result-item.error {
            border-left-color: #f48771;
        }

        .result-label {
            color: #6a9955;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .result-label.error {
            color: #f48771;
        }

        .result-content {
            color: #d4d4d4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* æœ€ç»ˆç»“æœå¡ç‰‡ - æ·±è‰²ä¸»é¢˜ */
        .result-card {
            background: #2d2d30;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .result-card h3 {
            font-size: 14px;
            color: #4ec9b0;
            margin-bottom: 10px;
        }

        .result-card .content {
            font-size: 13px;
            line-height: 1.6;
            color: #d4d4d4;
        }

        .success-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #0e7c3c;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 15px;
        }

        .btn-primary {
            background: #0e639c !important;
            color: white !important;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1177bb !important;
        }

        .btn-secondary {
            background: #3c3c3c !important;
            color: #d4d4d4 !important;
            border: 1px solid #454545 !important;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #505050 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸš€ AIOps Agent Demo</h1>
            <div class="selectors">
                <div class="selector-group">
                    <span class="selector-label">æ¨¡å¼:</span>
                    <select id="modeSelector">
                        <option value="chat">ğŸ’¬ Chat (RAG)</option>
                        <option value="agent" selected>ğŸ¤– Agent (Tool Calling)</option>
                    </select>
                </div>
                <div class="selector-group">
                    <span class="selector-label">æ¨¡å‹:</span>
                    <select id="modelSelector">
                        <option value="qwen-32b" selected>Qwen-32B</option>
                    </select>
                </div>
            </div>
        </header>

        <div class="main-card">
            <div class="input-section">
                <label for="errorLog">ğŸ“ è¾“å…¥é”™è¯¯æ—¥å¿—æˆ–æ•…éšœæè¿°ï¼š</label>
                <div class="textarea-wrapper">
                    <textarea id="errorLog" placeholder="è¯·è¾“å…¥é”™è¯¯æ—¥å¿—ã€å¼‚å¸¸å †æ ˆæˆ–æ•…éšœæè¿°...

ç¤ºä¾‹ï¼š
java.lang.OutOfMemoryError: Java heap space
    at java.util.Arrays.copyOf(Arrays.java:3332)
    at java.util.ArrayList.grow(ArrayList.java:275)"></textarea>
                </div>
                
                <div class="example-buttons">
                    <button class="example-btn" onclick="loadExample(1)">ğŸ“Œ ç¤ºä¾‹1: OOMé”™è¯¯</button>
                    <button class="example-btn" onclick="loadExample(2)">ğŸ“Œ ç¤ºä¾‹2: è¿æ¥è¶…æ—¶</button>
                    <button class="example-btn" onclick="loadExample(3)">ğŸ“Œ ç¤ºä¾‹3: æ•°æ®åº“è¿æ¥æ± </button>
                    <button class="example-btn" onclick="loadExample(4)">ğŸ“Œ ç¤ºä¾‹4: CPUé«˜è´Ÿè½½</button>
                </div>
            </div>

            <div class="button-group">
                <button class="btn-primary" onclick="diagnose()" id="diagnoseBtn">
                    ğŸ” å¼€å§‹è¯Šæ–­
                </button>
                <button class="btn-secondary" onclick="clearAll()">
                    ğŸ—‘ï¸ æ¸…ç©º
                </button>
            </div>

            <!-- Agent è¾“å‡ºåŒºåŸŸ (Windsurf é£æ ¼) -->
            <div id="agentOutput" style="display: none;">
                <div class="agent-output-header">
                    <span class="output-title">Real-time Agent Output</span>
                    <span class="streaming-badge" id="streamingStatus">âš¡ Streaming</span>
                </div>
                <div id="agentOutputContent"></div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>AI æ­£åœ¨åˆ†æä¸­ï¼Œè¯·ç¨å€™...</p>
            </div>

            <div class="result-section" id="resultSection">
                <div class="result-card">
                    <h3>ğŸ¯ æ•…éšœè¯Šæ–­</h3>
                    <div class="content" id="diagnosis"></div>
                </div>

                <div class="result-card">
                    <h3>ğŸ”¬ æ ¹æœ¬åŸå› </h3>
                    <div class="content" id="rootCause"></div>
                </div>

                <div class="result-card">
                    <h3>ğŸ’¡ è§£å†³æ–¹æ¡ˆ</h3>
                    <div class="content" id="solution"></div>
                </div>

                <div class="result-card">
                    <h3>ğŸ“Š ç½®ä¿¡åº¦</h3>
                    <div class="content">
                        <span class="confidence" id="confidence"></span>
                    </div>
                </div>

                <div class="cases-section">
                    <h3 style="margin-bottom: 15px; color: #667eea;">ğŸ“š ç›¸ä¼¼å†å²æ¡ˆä¾‹</h3>
                    <div id="casesContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const examples = {
            1: `java.lang.OutOfMemoryError: Java heap space
    at java.util.Arrays.copyOf(Arrays.java:3332)
    at java.util.ArrayList.grow(ArrayList.java:275)
    at java.util.ArrayList.ensureCapacityInternal(ArrayList.java:247)`,
            
            2: `java.net.SocketTimeoutException: connect timed out
    at java.net.PlainSocketImpl.socketConnect(Native Method)
    at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)
æœåŠ¡å™¨: 192.168.1.100:8080 æ— æ³•è¿æ¥`,
            
            3: `Cannot get connection, pool exhausted
org.apache.commons.dbcp2.PoolExhaustedException: Timeout waiting for idle object
    at org.apache.commons.pool2.impl.GenericObjectPool.borrowObject
æ•°æ®åº“è¿æ¥æ± å·²æ»¡ï¼Œå½“å‰æ´»è·ƒè¿æ¥: 50/50`,
            
            4: `æœåŠ¡å™¨CPUä½¿ç”¨ç‡æŒç»­è¶…è¿‡90%ï¼Œtopå‘½ä»¤æ˜¾ç¤ºï¼š
PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
1234 root      20   0 8192456 4.2g  12m S  95.3  5.6 100:23.45 java
åº”ç”¨å“åº”ç¼“æ…¢ï¼Œè¯·æ±‚è¶…æ—¶`
        };

        function loadExample(num) {
            document.getElementById('errorLog').value = examples[num];
        }

        function clearAll() {
            document.getElementById('errorLog').value = '';
            document.getElementById('agentOutput').style.display = 'none';
            document.getElementById('agentOutputContent').innerHTML = '';
            document.getElementById('resultSection').classList.remove('show');
            document.getElementById('diagnosis').innerHTML = '';
            document.getElementById('rootCause').innerHTML = '';
            document.getElementById('solution').innerHTML = '';
            thoughtCounter = 0;
        }

        // ========== å…¨å±€å˜é‡ ==========
        let thoughtCounter = 0;  // æ€è€ƒé“¾è®¡æ•°å™¨
        let currentThought = null;  // å½“å‰æ€è€ƒé“¾
        let thoughtStartTime = null;  // æ€è€ƒå¼€å§‹æ—¶é—´

        // ========== æµå¼è¯Šæ–­å‡½æ•° ==========
        async function diagnose() {
            const errorLog = document.getElementById('errorLog').value.trim();
            
            if (!errorLog) {
                alert('è¯·è¾“å…¥é”™è¯¯æ—¥å¿—ï¼');
                return;
            }

            // æ˜¾ç¤º Agent è¾“å‡ºåŒºåŸŸï¼Œä¸æ˜¾ç¤ºloading
            document.getElementById('loading').classList.remove('show');
            document.getElementById('resultSection').classList.remove('show');
            document.getElementById('diagnoseBtn').disabled = true;
            
            // æ¸…ç©ºå¹¶æ˜¾ç¤º Agent è¾“å‡ºåŒºåŸŸ
            const agentOutput = document.getElementById('agentOutput');
            const agentContent = document.getElementById('agentOutputContent');
            agentContent.innerHTML = '';
            agentOutput.style.display = 'block';
            document.getElementById('streamingStatus').textContent = 'âš¡ Streaming';
            document.getElementById('streamingStatus').style.color = '#4ec9b0';
            thoughtCounter = 0;
            currentThought = null;
            thoughtStartTime = null;
            
            // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
            document.getElementById('diagnosis').innerHTML = '';
            document.getElementById('rootCause').innerHTML = '';
            document.getElementById('solution').innerHTML = '';

            try {
                // ä»æ¨¡å¼é€‰æ‹©å™¨è·å–æ¨¡å¼
                const mode = document.getElementById('modeSelector').value;
                const useTools = (mode === 'agent');
                
                // ä½¿ç”¨ fetch çš„æµå¼ API
                const response = await fetch('/api/diagnose/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        error_log: errorLog,
                        use_tools: useTools
                    })
                });

                if (!response.ok) {
                    throw new Error('è¯Šæ–­è¯·æ±‚å¤±è´¥');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let diagnosisBuffer = '';

                // è¯»å–æµå¼æ•°æ®
                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, {stream: true});
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop(); // ä¿ç•™ä¸å®Œæ•´çš„è¡Œ
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.slice(6));
                            handleStreamEvent(data, diagnosisBuffer);
                            
                            if (data.type === 'diagnosis') {
                                diagnosisBuffer += data.content;
                            } else if (data.type === 'result_start') {
                                diagnosisBuffer = '';
                            }
                        }
                    }
                }

            } catch (error) {
                alert('è¯Šæ–­å¤±è´¥: ' + error.message);
            } finally {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('diagnoseBtn').disabled = false;
            }
        }

        // ========== Windsurf é£æ ¼äº‹ä»¶å¤„ç† ==========
        function handleStreamEvent(data) {
            const agentOutput = document.getElementById('agentOutput');
            const agentContent = document.getElementById('agentOutputContent');

            if (data.type === 'thinking') {
                // å¦‚æœè¿˜æ²¡æœ‰å½“å‰æ€è€ƒé“¾ï¼Œåˆ›å»ºæ–°çš„
                if (!currentThought || currentThought.dataset.completed === 'true') {
                    thoughtStartTime = Date.now();
                    const thoughtId = `thought-${++thoughtCounter}`;
                    const thoughtDiv = document.createElement('div');
                    thoughtDiv.className = 'thought-item';
                    thoughtDiv.id = thoughtId;
                    thoughtDiv.dataset.completed = 'false';
                    thoughtDiv.innerHTML = `
                        <div class="thought-header" onclick="toggleThought('${thoughtId}')">
                            <div class="thought-title">
                                <span class="expand-icon">â–¶</span>
                                <span>Thought</span>
                            </div>
                            <span class="thought-duration">æ€è€ƒä¸­...</span>
                        </div>
                        <div class="thought-content"></div>
                    `;
                    
                    agentContent.appendChild(thoughtDiv);
                    currentThought = thoughtDiv;
                }
                
                // è¿½åŠ å†…å®¹åˆ°å½“å‰æ€è€ƒé“¾
                const contentDiv = currentThought.querySelector('.thought-content');
                const line = document.createElement('div');
                line.textContent = data.content;
                line.style.marginBottom = '4px';
                contentDiv.appendChild(line);
                
                agentContent.scrollTop = agentContent.scrollHeight;
                
            } else if (data.type === 'tool_call') {
                // æ ‡è®°å½“å‰æ€è€ƒé“¾å®Œæˆ
                if (currentThought && currentThought.dataset.completed !== 'true') {
                    currentThought.dataset.completed = 'true';
                    const duration = ((Date.now() - thoughtStartTime) / 1000).toFixed(1);
                    const durationSpan = currentThought.querySelector('.thought-duration');
                    if (durationSpan) {
                        durationSpan.textContent = `for ${duration}s`;
                        durationSpan.style.color = '#6a9955';
                    }
                }
                
                // å·¥å…·è°ƒç”¨
                const cmd = data.args.command || JSON.stringify(data.args);
                const toolCallDiv = document.createElement('div');
                toolCallDiv.className = 'tool-call-item';
                toolCallDiv.innerHTML = `
                    <div class="tool-label">ğŸ”§ æ‰§è¡Œå‘½ä»¤</div>
                    <div class="tool-command">${escapeHtml(cmd)}</div>
                `;
                
                agentContent.appendChild(toolCallDiv);
                agentContent.scrollTop = agentContent.scrollHeight;
                
            } else if (data.type === 'tool_result') {
                // å·¥å…·ç»“æœ
                const success = data.success !== false;
                const content = data.content || '';
                const displayContent = content.length > 500 ? content.substring(0, 500) + '...' : content;
                
                const resultDiv = document.createElement('div');
                resultDiv.className = `tool-result-item ${success ? '' : 'error'}`;
                resultDiv.innerHTML = `
                    <div class="result-label ${success ? '' : 'error'}">${success ? 'âœ“' : 'âœ—'} å‘½ä»¤ç»“æœ</div>
                    <div class="result-content">${escapeHtml(displayContent)}</div>
                `;
                
                agentContent.appendChild(resultDiv);
                agentContent.scrollTop = agentContent.scrollHeight;
                
            } else if (data.type === 'llm_chunk') {
                // LLM æµå¼è¾“å‡ºï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰
                const diagnosisDiv = document.getElementById('diagnosis');
                let content = data.content;
                
                // è¿‡æ»¤æ‰ <think> æ ‡ç­¾å†…å®¹ï¼ˆä¸æ˜¾ç¤º LLM çš„å†…éƒ¨æ€è€ƒï¼‰
                content = content.replace(/<think>[\s\S]*?<\/think>/gi, '');
                content = content.replace(/<think>/gi, '').replace(/<\/think>/gi, '');
                
                if (content.trim()) {
                    diagnosisDiv.textContent += content;
                }
                
            } else if (data.type === 'result_start') {
                // å¼€å§‹æ˜¾ç¤ºç»“æœ
                document.getElementById('loading').classList.remove('show');
                document.getElementById('resultSection').classList.add('show');
                
            } else if (data.type === 'diagnosis') {
                // æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºè¯Šæ–­
                const diagnosisDiv = document.getElementById('diagnosis');
                diagnosisDiv.textContent += data.content;
                
            } else if (data.type === 'root_cause') {
                document.getElementById('rootCause').textContent = data.content;
                
            } else if (data.type === 'solution') {
                const solutionDiv = document.getElementById('solution');
                if (Array.isArray(data.content)) {
                    solutionDiv.innerHTML = data.content.map((s, i) => `${i + 1}. ${s}`).join('<br>');
                } else {
                    solutionDiv.textContent = data.content;
                }
                
            } else if (data.type === 'confidence') {
                const conf = data.value;
                const confElement = document.getElementById('confidence');
                confElement.textContent = `${(conf * 100).toFixed(0)}%`;
                confElement.className = 'confidence ' + (conf > 0.7 ? 'high' : conf > 0.4 ? 'medium' : 'low');
                
            } else if (data.type === 'cases') {
                displayCases(data.data);
                
            } else if (data.type === 'final_result') {
                // æ˜¾ç¤ºæœ€ç»ˆç»“æ„åŒ–ç»“æœ
                document.getElementById('loading').classList.remove('show');
                document.getElementById('resultSection').classList.add('show');
                
                const result = data.data;
                
                // æ˜¾ç¤ºè¯Šæ–­ç»“æœ
                document.getElementById('diagnosis').textContent = result.diagnosis || '';
                document.getElementById('rootCause').textContent = result.root_cause || '';
                
                const solutionDiv = document.getElementById('solution');
                if (Array.isArray(result.solution)) {
                    solutionDiv.innerHTML = result.solution.map((s, i) => `${i + 1}. ${s}`).join('<br>');
                } else {
                    solutionDiv.textContent = result.solution || '';
                }
                
                const conf = result.confidence || 0.5;
                const confElement = document.getElementById('confidence');
                confElement.textContent = `${(conf * 100).toFixed(0)}%`;
                confElement.className = 'confidence ' + (conf > 0.7 ? 'high' : conf > 0.4 ? 'medium' : 'low');
                
                if (result.retrieved_cases) {
                    displayCases(result.retrieved_cases);
                }
                
            } else if (data.type === 'done') {
                // è¯Šæ–­å®Œæˆ - æ·»åŠ æˆåŠŸå¾½ç« 
                const agentContent = document.getElementById('agentOutputContent');
                const badge = document.createElement('div');
                badge.className = 'success-badge';
                badge.textContent = 'âœ“ è¯Šæ–­å®Œæˆ';
                agentContent.appendChild(badge);
                
                // æ›´æ–°çŠ¶æ€
                document.getElementById('streamingStatus').textContent = 'âœ“ Complete';
                document.getElementById('streamingStatus').style.color = '#6a9955';
                
                // ç¡®ä¿éšè—loadingå¹¶é‡æ–°å¯ç”¨æŒ‰é’®
                document.getElementById('loading').classList.remove('show');
                document.getElementById('diagnoseBtn').disabled = false;
            }
        }

        // åˆ‡æ¢æ€è€ƒé“¾å±•å¼€/æŠ˜å 
        function toggleThought(thoughtId) {
            const thought = document.getElementById(thoughtId);
            if (thought) {
                thought.classList.toggle('expanded');
            }
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function displayCases(cases) {
            // æ˜¾ç¤ºç›¸ä¼¼æ¡ˆä¾‹
            const casesContainer = document.getElementById('casesContainer');
            if (!casesContainer) return;
            
            casesContainer.innerHTML = '';
            
            if (!cases || cases.length === 0) {
                casesContainer.innerHTML = '<p style="color: #999;">æš‚æ— ç›¸ä¼¼æ¡ˆä¾‹</p>';
                return;
            }
            
            cases.forEach((c, index) => {
                const caseDiv = document.createElement('div');
                caseDiv.className = 'case-item';
                caseDiv.innerHTML = `
                    <div class="case-header">
                        <span class="case-title">æ¡ˆä¾‹ ${index + 1}: ${c.error_type || 'æœªçŸ¥'}</span>
                        <span class="similarity">ç›¸ä¼¼åº¦: ${((c.similarity || 0) * 100).toFixed(0)}%</span>
                    </div>
                    <div style="margin-top: 8px; color: #666; font-size: 13px;">
                        <strong>åŸå› ï¼š</strong>${c.root_cause || ''}<br>
                        <strong>æ–¹æ¡ˆï¼š</strong>${c.solution || ''}
                    </div>
                `;
                casesContainer.appendChild(caseDiv);
            });
        }

        function displayResult(result) {
            // æ˜¾ç¤ºè¯Šæ–­ç»“æœ
            document.getElementById('diagnosis').textContent = result.diagnosis;
            document.getElementById('rootCause').textContent = result.root_cause;
            document.getElementById('solution').textContent = result.solution;

            // ç½®ä¿¡åº¦
            const confidence = result.confidence;
            const confidenceEl = document.getElementById('confidence');
            confidenceEl.textContent = `${(confidence * 100).toFixed(1)}%`;
            
            if (confidence >= 0.8) {
                confidenceEl.className = 'confidence high';
            } else if (confidence >= 0.5) {
                confidenceEl.className = 'confidence medium';
            } else {
                confidenceEl.className = 'confidence low';
            }

            // ç›¸ä¼¼æ¡ˆä¾‹
            const casesHtml = result.retrieved_cases.map(c => `
                <div class="case-item">
                    <div class="case-header">
                        <span class="case-title">${c.error_type}</span>
                        <span class="similarity">${(c.similarity * 100).toFixed(1)}% ç›¸ä¼¼</span>
                    </div>
                    <div style="color: #666; font-size: 0.9em; margin-top: 8px;">
                        <div><strong>æ ¹å› :</strong> ${c.root_cause}</div>
                        <div style="margin-top: 5px;"><strong>æ–¹æ¡ˆ:</strong> ${c.solution}</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('retrievedCases').innerHTML = casesHtml || '<p style="color: #999;">æ— ç›¸ä¼¼æ¡ˆä¾‹</p>';

            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            document.getElementById('resultSection').classList.add('show');
        }
    </script>
</body>
</html>
